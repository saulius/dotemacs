#+TITLE: clojure

* Clojure

Configuration for [[http://clojure.org][Clojure]] programming language.

#+BEGIN_SRC emacs-lisp
(use-package clojure-mode
  :ensure t
  :mode (("\\.boot$"  . clojure-mode)
         ("\\.clj$"   . clojure-mode)
         ("\\.cljs$"  . clojure-mode)
         ("\\.cljx$"  . clojure-mode)
         ("\\.edn$"   . clojure-mode)
         ("\\.cljc$"  . clojure-mode))
  :config
  (defun clojure-mode-defaults ()
    (smartparens-strict-mode 1)
    (subword-mode 1))

  (defun cider-eval-expression-at-point-in-repl ()
    (interactive)
    (let ((form (cider-defun-at-point)))
      ;; Strip excess whitespace
      (while (string-match "\\`\s+\\|\n+\\'" form)
             (setq form (replace-match "" t t form)))
       (set-buffer (cider-get-repl-buffer))
       (goto-char (point-max))
       (insert form)
       (cider-repl-return)))

  (evil-leader/set-key-for-mode 'clojure-mode
    "m ," 'cider-test-run-tests
    "m p" 'check-parens
    "m J" 'cider-jack-in
    "m n" 'cider-repl-set-ns
    "m k" 'cider-load-buffer
    "m s" 'cider-eval-expression-at-point-in-repl
    "m m" 'cider-macroexpand-1
    "m c" 'cider-eval-expression-at-point-in-repl
    "m d" 'cider-doc-map
    "m r" 'cider-refresh
    "m R" 'cider-reset)

   ;; indent component service lifecycle macros as functions
  (put-clojure-indent 'init 'defun)
  (put-clojure-indent 'start 'defun)
  (put-clojure-indent 'stop 'defun)

  (setq my-clojure-mode-hook 'clojure-mode-defaults)

  (add-hook 'my-clojure-mode-hook (lambda ()
                                    (run-hooks 'my-clojure-mode-hook))))

(use-package cider
  :ensure t
  :init
  (setq cider-repl-pop-to-buffer-on-connect t)
  (setq cider-prompt-save-file-on-load nil)
  :config
  (add-hook 'cider-mode-hook 'cider-turn-on-eldoc-mode)

  (dolist (mode '(cider-repl-mode
                  cider-error-buffer
                  cider-test-report-mode
                  cider-inspector-mode
                  cider-macroexpansion-mode
                  cider-stacktrace-mode
                  cider-docview-mode))
    (evil-set-initial-state mode 'emacs))

  (defun cider-repl-mode-defaults ()
    (add-hook 'after-save-hook
          (lambda ()
             (if (and (boundp 'cider-mode) cider-mode)
               (cider-refresh))))
    (subword-mode 1)
    (smartparens-strict-mode 1))

  (setq cider-repl-mode-hook 'cider-repl-mode-defaults)
  ;; Prevent C-c C-k from prompting to save the file corresponding to the buffer being loaded, if it's modified:
  (setq cider-prompt-save-file-on-load nil)

  (add-hook 'cider-mode-hook (lambda ()
                             (run-hooks 'cider-repl-mode-hook))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(use-package evil-lisp-state
  :ensure t
  :config
  (define-key evil-normal-state-map "L" 'evil-lisp-state)
  (setq evil-lisp-state-cursor  '("orange" bar)))
#+END_SRC
